#include <stdio.h>
#include "twiddle.h"

// lookup table for values of sin from 0 to pi/2 in pi/80 increments
#define TAYLOR 0 // Degree of taylor expansion to use; 0, 1, or 2
#define LUT_SIZE 128

const float lut[LUT_SIZE] = {
	0.        , 0.01227154, 0.02454123, 0.03680722, 0.04906767,
	0.06132074, 0.07356456, 0.08579731, 0.09801714, 0.11022221,
	0.12241068, 0.13458071, 0.14673047, 0.15885814, 0.17096189,
	0.18303989, 0.19509032, 0.20711138, 0.21910124, 0.23105811,
	0.24298018, 0.25486566, 0.26671276, 0.27851969, 0.29028468,
	0.30200595, 0.31368174, 0.32531029, 0.33688985, 0.34841868,
	0.35989504, 0.37131719, 0.38268343, 0.39399204, 0.40524131,
	0.41642956, 0.42755509, 0.43861624, 0.44961133, 0.46053871,
	0.47139674, 0.48218377, 0.49289819, 0.50353838, 0.51410274,
	0.52458968, 0.53499762, 0.54532499, 0.55557023, 0.56573181,
	0.57580819, 0.58579786, 0.5956993 , 0.60551104, 0.61523159,
	0.62485949, 0.63439328, 0.64383154, 0.65317284, 0.66241578,
	0.67155895, 0.680601  , 0.68954054, 0.69837625, 0.70710678,
	0.71573083, 0.72424708, 0.73265427, 0.74095113, 0.74913639,
	0.75720885, 0.76516727, 0.77301045, 0.78073723, 0.78834643,
	0.7958369 , 0.80320753, 0.8104572 , 0.81758481, 0.8245893 ,
	0.83146961, 0.83822471, 0.84485357, 0.85135519, 0.85772861,
	0.86397286, 0.87008699, 0.87607009, 0.88192126, 0.88763962,
	0.8932243 , 0.89867447, 0.90398929, 0.90916798, 0.91420976,
	0.91911385, 0.92387953, 0.92850608, 0.9329928 , 0.93733901,
	0.94154407, 0.94560733, 0.94952818, 0.95330604, 0.95694034,
	0.96043052, 0.96377607, 0.96697647, 0.97003125, 0.97293995,
	0.97570213, 0.97831737, 0.98078528, 0.98310549, 0.98527764,
	0.98730142, 0.98917651, 0.99090264, 0.99247953, 0.99390697,
	0.99518473, 0.99631261, 0.99729046, 0.99811811, 0.99879546,
	0.99932238, 0.99969882, 0.9999247
};

struct cnum twiddle(float real, float im, uint16_t k, uint16_t b) {
	// The computation we have to do is:
	// real = mult_real(real, im, cosine(-PI*k/b), sine(-PI*k/b))
	// imagine = mult_im(real, im, cosine(-PI*k/b), sine(-PI*k/b))
	float cos, sin;
	while(b != (2*LUT_SIZE)) {
		b *= 2;
		k *= 2;
	}
	if(k > LUT_SIZE) {
		k = (2*LUT_SIZE) - k;
		cos = -1 * lut[LUT_SIZE - k];
	}
	sin = lut[k];

	return (struct cnum) {real * cos - im * sin, real * sin + im * cos};
}
